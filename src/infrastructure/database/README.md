# Database Layer

This folder contains everything related to PostgreSQL + TypeORM persistence.

## Components

| File/Directory | Description |
|----------------|-------------|
| `data-source.ts` | Configures `AppDataSource`, reads env vars (`DATABASE_URL` or `DATABASE_*`) and registers entities + migrations. |
| `entities/` | TypeORM mappings (`UserEntity`, `PlanEntity`, `PlanPriceEntity`, `SubscriptionEntity`, etc.). |
| `migrations/` | CLI-generated migrations (`1729020000000-InitSchema.ts` creates the full schema). |

## Relevant environment variables

```
DATABASE_URL=postgres://user:pass@host:port/db   # optional
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=subscription_express
TYPEORM_LOGGING=false
```

`DATABASE_URL` takes precedence over the individual settings when defined.

## Useful commands

```bash
# Apply migrations
npm run migration:run

# Revert last migration
npm run migration:revert

# Generate a new migration from entities
npm run migration:generate -- --name AddSomething
```

> Make sure PostgreSQL is running (e.g., `docker compose up -d postgres`) before executing these commands.

## Conventions

- Enums (e.g., `subscription_status`, `payment_status`) specify `enumName` so migrations reuse the same PostgreSQL type.
- IDs are UUIDs (generated by use cases through `UuidIdGenerator`).
- `updated_by` optionally references `users.id`; automated processes can leave it `NULL` or use a system user.
- User roles live in the `user_role` enum (`admin`, `operator`, `user`) with default `user`.
